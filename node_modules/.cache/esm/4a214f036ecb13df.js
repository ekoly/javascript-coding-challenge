"main";let http;_6ec‍.w("http",[["default",["http"],function(v){http=v}]]);let polka;_6ec‍.w("polka",[["default",["polka"],function(v){polka=v}]]);let send;_6ec‍.w("@polka/send-type",[["default",["send"],function(v){send=v}]]);let cors;_6ec‍.w("cors",[["default",["cors"],function(v){cors=v}]]);let fetch;_6ec‍.w("node-fetch",[["default",["fetch"],function(v){fetch=v}]]);let fs;_6ec‍.w("fs",[["default",["fs"],function(v){fs=v}]]);let html;_6ec‍.w("./html.js",[["default",["html"],function(v){html=v}]]);let users;_6ec‍.w("./users.js",[["default",["users"],function(v){users=v}]]);// @ts-check












const PORT = process.env.PORT;
const app = polka();

app.use(cors());

app.get('/healthcheck', (_, res) => res.end('OK'));

app.post('/mocky-api', async (req, res) => {
  const url = 'http://www.mocky.io/v2/5b60920b2f00008e364619ee?mocky-delay=' + Math.floor(Math.random() * 3e3) + 'ms';
  
  try {
      let response = await fetch(url, {
        timeout: 10e3,
        agent: new http.Agent({ keepAlive: true }),
      });

      if (!response.ok || response.status > 300) {
          throw new Error('Fetch error');
      }

      let d = await response.json();
      send(res, 200, d);

  } catch(e) {
      _6ec‍.g.console.error('Unable to fetch', e);
    
      return send(
        res,
        500,
        { error: { message: e.message } },
        { 'Content-Type': 'application/json' });
  }
});

app.post('/data', (req, res) => {
  const { uid } = req.query;
  const uid_arr = uid.split(',').map(s => +s.trim());
  const d = users.users.filter(n => uid_arr.includes(n.id));
  
  return send(res, 200, d, { 'Content-Type': 'application/json' });
});

app.get('/', async (_, res) => {
  const msg = 'Hello, World!';
  const d = await html`<h1>${msg}</h1>`;
  
  return send(res, 200, d, { 'Content-Type': 'text/html' });
});

app.get('/form', (req, res) => {
  const form = fs.readFile("./form.html");

  return send(res, 200, form, { 'Content-Type': 'text/html' });
});

app
  .listen(PORT)
  .then(() => {
    _6ec‍.g.console.info(`Polka running at port ${PORT}...`)
  });
